const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["copilot_web/WorkflowOption-lbGaSVN-.js","copilot_web/vendor-markdown-Dek94WS0.js","copilot_web/vendor-react-V04_Axys.js","copilot_web/message-components-DAhwqZXx.js"])))=>i.map(i=>d[i]);
import{j as e}from"./vendor-markdown-Dek94WS0.js";import{r as o,R as F}from"./vendor-react-V04_Axys.js";import{a as I,B as te,U as ne,b as se,g as S,A as K,c as oe,W as T}from"./message-components-DAhwqZXx.js";import{l as re}from"./App-DDLwSOc-.js";import{_ as R}from"./input.js";function ae(t){return e.jsxs("svg",{...t,xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"m22 2-7 20-4-9-9-4Z"}),e.jsx("path",{d:"M22 2 11 13"})]})}function U(t){return e.jsxs("svg",{...t,xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M18 6 6 18"}),e.jsx("path",{d:"m6 6 12 12"})]})}function ie(t){return e.jsxs("svg",{...t,xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M3 6h18"}),e.jsx("path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"}),e.jsx("path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"})]})}function le(t){return e.jsxs("svg",{...t,xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2"}),e.jsx("circle",{cx:"9",cy:"9",r:"2"}),e.jsx("path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"})]})}function ce(t){return e.jsxs("svg",{...t,xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M12 5v14"}),e.jsx("path",{d:"M5 12h14"})]})}function de(t){return e.jsxs("svg",{...t,xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"}),e.jsx("circle",{cx:"12",cy:"12",r:"3"})]})}function ue({isOpen:t,onClose:p,onSave:h,initialApiKey:u=""}){const[f,g]=o.useState(u),[i,n]=o.useState(!1);return o.useEffect(()=>{g(u)},[u]),t?e.jsx("div",{className:"fixed inset-0 bg-gray-500 bg-opacity-25 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-96 shadow-xl",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:"Set API Key"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:i?"text":"password",value:f,onChange:b=>g(b.target.value),placeholder:"Enter your API key",className:"w-full px-3 py-2 border border-gray-300 rounded-md mb-4 pr-10 bg-gray-50"}),e.jsx("button",{type:"button",className:"absolute inset-y-0 right-0 pr-3 flex items-center text-gray-600 hover:text-gray-800",onClick:()=>n(!i),children:i?e.jsxs("svg",{className:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"}),e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"})]}):e.jsx("svg",{className:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"})})})]}),e.jsxs("div",{className:"mb-4 text-sm text-gray-600",children:[e.jsx("span",{children:"Don't have an API key? "}),e.jsx("a",{href:"https://form.typeform.com/to/tkg91K8D",target:"_blank",rel:"noopener noreferrer",className:"text-blue-500 hover:text-blue-600 underline",children:"Click here to request one"})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{onClick:p,className:"px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-md",children:"Cancel"}),e.jsx("button",{onClick:()=>{h(f),p()},className:"px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600",children:"Save"})]})]})}):null}function he({onClose:t,onClear:p,hasMessages:h}){const[u,f]=o.useState(!1),g=()=>{f(!0)},i=n=>{localStorage.setItem("chatApiKey",n)};return e.jsxs("div",{className:`flex items-center justify-between border-b px-4 py-3 
                        bg-white border-gray-200 sticky top-0 z-10`,children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("img",{src:re,alt:"ComfyUI-Copilot Logo",className:"h-12 w-12 -ml-2"}),e.jsx("h3",{className:"text-[16px] font-medium text-gray-800",children:"ComfyUI-Copilot"}),e.jsx("button",{onClick:g,className:"p-1 hover:bg-gray-100 rounded text-gray-500",children:e.jsx(de,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{className:`inline-flex items-center justify-center rounded-md p-2 
                             text-gray-500 hover:bg-gray-100 hover:text-gray-600 
                             disabled:opacity-50 transition-colors duration-200`,disabled:!h,onClick:p,children:e.jsx(ie,{className:"h-5 w-5"})}),e.jsx("button",{className:`inline-flex items-center justify-center rounded-md p-2 
                             text-gray-500 hover:bg-gray-100 hover:text-gray-600 
                             transition-colors duration-200`,onClick:t,children:e.jsx(U,{className:"h-5 w-5"})})]}),e.jsx(ue,{isOpen:u,onClose:()=>f(!1),onSave:i,initialApiKey:localStorage.getItem("chatApiKey")||""})]})}const me=5*1024*1024,G=["image/jpeg","image/png","image/gif","image/webp"];function pe({input:t,loading:p,onChange:h,onSend:u,onKeyPress:f,onUploadImages:g,uploadedImages:i,onRemoveImage:n,selectedModel:b,onModelChange:v}){const[C,j]=o.useState(!1),_=F.useRef(null),E=r=>{if(r.target.files){const l=[],c=[];if(Array.from(r.target.files).forEach(x=>{G.includes(x.type)?x.size>me?l.push(`${x.name} (exceeds 5MB)`):c.push(x):l.push(`${x.name} (unsupported format)`)}),l.length>0&&alert(`The following files couldn't be uploaded:
${l.join(`
`)}`),c.length>0){const x=new DataTransfer;c.forEach(L=>x.items.add(L)),g(x.files)}}};return e.jsxs("div",{className:`relative ${i.length>0?"mt-12":""}`,children:[i.length>0&&e.jsx("div",{className:"absolute -top-10 left-0 flex gap-2",children:i.map(r=>e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:r.preview,alt:"uploaded",className:"w-8 h-8 rounded object-cover"}),e.jsx("button",{onClick:()=>n(r.id),className:`absolute -top-1 -right-1 bg-red-500 text-white rounded-full p-0.5
                                         opacity-0 group-hover:opacity-100 transition-opacity`,children:e.jsx(U,{className:"w-3 h-3"})})]},r.id))}),e.jsx("textarea",{onChange:h,onKeyDown:r=>{if(r.key==="Enter"&&!r.shiftKey){if(r.nativeEvent.isComposing)return;r.preventDefault(),u()}f(r)},value:t,placeholder:"Type your message...",className:`w-full min-h-[80px] max-h-[400px] resize-none rounded-md border 
                         border-gray-200 px-3 py-2 pr-12 pb-10 text-sm shadow-sm 
                         focus:outline-none focus:ring-2 focus:ring-blue-500 
                         focus:border-transparent bg-white transition-all 
                         duration-200 text-gray-700 overflow-y-auto`,style:{height:"auto"}}),e.jsxs("div",{className:`absolute bottom-2 left-3 right-12 flex items-center gap-2 
                          bg-white border-t border-gray-100 pt-1`,children:[e.jsxs("select",{value:b,onChange:r=>v(r.target.value),className:`px-1.5 py-0.5 text-xs rounded-md 
                             border border-gray-200 bg-white text-gray-700
                             focus:outline-none focus:ring-2 focus:ring-blue-500
                             focus:border-transparent hover:bg-gray-50
                             transition-colors border-0`,children:[e.jsx("option",{value:"gpt-4o-mini",children:"gpt-4o-mini"}),e.jsx("option",{value:"gpt-4o",children:"gpt-4o"}),e.jsx("option",{value:"DeepSeek-V3",children:"DeepSeek-V3"})]}),e.jsx("button",{type:"button",onClick:()=>j(!0),className:`p-1.5 text-gray-500 
                             hover:bg-gray-100 hover:text-gray-600 
                             transition-all duration-200 outline-none`,children:e.jsx(le,{className:"h-4 w-4"})})]}),e.jsx("button",{type:"submit",onClick:u,disabled:p,className:`absolute bottom-3 right-3 p-2 rounded-md text-gray-500 
                         hover:bg-gray-100 hover:text-gray-600 disabled:opacity-50 
                         transition-all duration-200 active:scale-95`,children:p?e.jsx("div",{className:`h-5 w-5 animate-spin rounded-full 
                                  border-2 border-gray-300 border-t-blue-500`}):e.jsx(ae,{className:`h-5 w-5 transform transition-transform 
                                       group-hover:translate-x-1`})}),C&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-96 relative",children:[e.jsx("button",{onClick:()=>j(!1),className:"absolute top-2 right-2 text-gray-500 hover:text-gray-700",children:e.jsx(U,{className:"w-5 h-5"})}),e.jsx("h3",{className:"text-lg font-medium mb-4",children:"Upload Images"}),e.jsxs("div",{className:`border-2 border-dashed border-gray-300 rounded-lg p-8
                                      flex flex-col items-center justify-center gap-4
                                      hover:border-blue-500 transition-colors cursor-pointer`,onClick:()=>_.current?.click(),children:[e.jsx(ce,{className:"w-8 h-8 text-gray-400"}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-gray-500 mb-2",children:"Click to upload images or drag and drop"}),e.jsx("p",{className:"text-xs text-gray-400",children:"Supported formats: JPG, PNG, GIF, WebP"}),e.jsx("p",{className:"text-xs text-gray-400",children:"Max file size: 5MB"})]})]}),e.jsx("input",{ref:_,type:"file",multiple:!0,accept:G.join(","),onChange:E,className:"hidden"}),i.length>0&&e.jsx("div",{className:"mt-4 grid grid-cols-3 gap-2",children:i.map(r=>e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:r.preview,alt:"preview",className:"w-full h-20 object-cover rounded"}),e.jsx("button",{onClick:()=>n(r.id),className:`absolute -top-1 -right-1 bg-red-500 text-white 
                                                     rounded-full p-0.5 opacity-0 group-hover:opacity-100 
                                                     transition-opacity`,children:e.jsx(U,{className:"w-3 h-3"})})]},r.id))}),e.jsx("div",{className:"mt-4 flex justify-end gap-2",children:e.jsx("button",{onClick:()=>j(!1),className:`px-4 py-2 text-sm font-medium text-gray-700 
                                         bg-white border border-gray-300 rounded-md 
                                         hover:bg-gray-50`,children:"Close"})})]})})]})}function fe(){const t=Object.values(I.canvas.selected_nodes)[0],p=new Set;function h(u,f){if(!(!u||f>=1)&&u.inputs)for(const g of Object.values(u.inputs)){const i=g.link;if(i&&I.graph.links[i]){const n=I.graph.links[i].origin_id,b=I.graph._nodes_by_id[n];b&&(p.add(b.type),h(b,f+1))}}}return t?(h(t,0),[{type:"upstream_node_types",data:Array.from(p)}]):null}function ge({nodeInfo:t,onSendWithIntent:p,loading:h}){return e.jsx("div",{className:`mb-3 p-3 rounded-md bg-gray-50 border border-gray-200 
                      transform transition-all duration-200 hover:shadow-md`,children:e.jsxs("div",{className:"text-sm",children:[e.jsxs("p",{children:["Selected node: ",t.type]}),e.jsxs("div",{className:"flex gap-2 mt-2",children:[e.jsx("button",{className:`px-3 py-1 text-xs rounded-md bg-blue-50 
                                 hover:bg-blue-100 text-blue-700 transition-all 
                                 duration-200 hover:shadow-sm active:scale-95`,onClick:()=>p("node_explain"),disabled:h,children:"Usage"}),e.jsx("button",{className:`px-3 py-1 text-xs rounded bg-green-100 
                                 hover:bg-green-200 text-green-700 transition-colors`,onClick:()=>p("node_params"),disabled:h,children:"Parameters"}),e.jsx("button",{className:`px-3 py-1 text-xs rounded bg-purple-100 
                                 hover:bg-purple-200 text-purple-700 transition-colors`,onClick:()=>p("downstream_subgraph_search",fe()),disabled:h,children:"Downstream Nodes"})]})]})})}function xe(){return e.jsx(te,{name:"Assistant",children:e.jsxs("div",{className:"flex items-center space-x-2 p-4 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex space-x-1",children:[e.jsx("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"0ms"}}),e.jsx("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"150ms"}}),e.jsx("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"300ms"}})]}),e.jsx("span",{className:"text-sm text-gray-500",children:"AI is thinking..."})]})})}const ye=t=>`https://ui-avatars.com/api/?name=${t||"User"}&background=random`,be=o.lazy(()=>R(()=>import("./WorkflowOption-lbGaSVN-.js"),__vite__mapDeps([0,1,2,3])).then(t=>({default:t.WorkflowOption}))),ve=o.lazy(()=>R(()=>import("./message-components-DAhwqZXx.js").then(t=>t.N),__vite__mapDeps([3,2,1])).then(t=>({default:t.NodeSearch}))),je=o.lazy(()=>R(()=>import("./message-components-DAhwqZXx.js").then(t=>t.d),__vite__mapDeps([3,2,1])).then(t=>({default:t.NodeRecommend}))),we=o.lazy(()=>R(()=>import("./message-components-DAhwqZXx.js").then(t=>t.D),__vite__mapDeps([3,2,1])).then(t=>({default:t.DownstreamSubgraphs}))),Ne=o.lazy(()=>R(()=>import("./message-components-DAhwqZXx.js").then(t=>t.e),__vite__mapDeps([3,2,1])).then(t=>({default:t.NodeInstallGuide})));function ke({messages:t,latestInput:p,onOptionClick:h,installedNodes:u,onAddMessage:f,loading:g}){const i=n=>{if(console.log("[MessageList] Rendering message:",n),n.role==="user")return e.jsx(ne,{content:n.content,trace_id:n.trace_id},n.id);if(n.role==="ai"||n.role==="tool"){const b=ye(n.role);try{const v=JSON.parse(n.content);console.log("[MessageList] Parsed message content:",v);const C=v.ext?.find(c=>c.type==="workflow"),j=v.ext?.find(c=>c.type==="node"),_=v.ext?.find(c=>c.type==="node_recommend"),E=v.ext?.find(c=>c.type==="downstream_subgraph_search"),r=v.ext?.find(c=>c.type==="node_install_guide");console.log("[MessageList] Found extensions:",{workflowExt:C,nodeExt:j,nodeRecommendExt:_,downstreamSubgraphsExt:E,nodeInstallGuideExt:r});let l=null;return C?l=e.jsx(be,{content:n.content,name:n.name,latestInput:p,installedNodes:u,onAddMessage:f}):_?l=e.jsx(je,{content:n.content,name:n.name,avatar:b,installedNodes:u}):j?l=e.jsx(ve,{content:n.content,name:n.name,avatar:b,installedNodes:u}):E?l=e.jsx(we,{content:n.content,name:n.name,avatar:b,installedNodes:u,onAddMessage:f}):r&&(l=e.jsx(Ne,{content:n.content,onLoadSubgraph:()=>{if(n.metadata?.pendingSubgraph){const c=Object.values(I.canvas.selected_nodes)[0];if(c){const x=n.metadata.pendingSubgraph,L=x.json.nodes,O=x.json.links,W=L.find(m=>m.id===0),A=W?.id,M={};A&&(M[A]=c),I.canvas.emitBeforeChange();try{for(const m of L)if(m.id!==A){const w=W?.pos,N=[c._pos[0],c._pos[1]],z=[m.pos[0]+N[0]-w[0],m.pos[1]+N[1]-w[1]];M[m.id]=se(m.type,{pos:z})}}finally{I.canvas.emitAfterChange()}for(const m of O){const w=M[m.origin_id],N=M[m.target_id];w&&N&&w.connect(m.origin_slot,N,m.target_slot)}}else alert("Please select a upstream node first before adding a subgraph.")}else if(n.metadata?.pendingWorkflow){const c=n.metadata.pendingWorkflow,x=n.metadata.optimizedParams;I.loadGraphData(c);for(const[O,W,A,M,m]of x){const w=I.graph._nodes_by_id[O].widgets;for(const N of w)N.name===M&&(N.value=m)}I.graph.setDirtyCanvas(!1,!0);const L={id:S(),role:"tool",content:JSON.stringify({text:"The workflow has been successfully loaded to the canvas",ext:[]}),format:"markdown",name:"Assistant"};f?.(L)}}})),v.text||l?e.jsx(K,{content:n.content,name:n.name,format:n.format,onOptionClick:h,extComponent:l},n.id):l||e.jsx(K,{content:n.content,name:n.name,format:n.format,onOptionClick:h},n.id)}catch(v){return console.error("[MessageList] Error parsing message content:",v),console.error("解析JSON失败",n.content),e.jsx(K,{content:n.content,name:n.name,format:n.format,onOptionClick:h},n.id)}}return null};return e.jsxs("div",{className:"flex flex-col gap-4 w-full",children:[t?.map(i),g&&e.jsx(xe,{})]})}async function Ie(){try{return await(await oe.fetchApi("/object_info",{method:"GET"})).json()}catch(t){throw console.error("Error fetching object info:",t),t}}async function _e(){const t=await Ie();return Object.keys(t)}function De({onClose:t,visible:p=!0,triggerUsage:h=!1,onUsageTriggered:u}){const[f,g]=o.useState([]),[i,n]=o.useState(""),[b,v]=o.useState(""),[C,j]=o.useState(!1),[_,E]=o.useState(),r=o.useRef(null),[l,c]=o.useState(null),[x,L]=o.useState([]),[O,W]=o.useState(window.innerWidth/3),[A,M]=o.useState(!1),[m,w]=o.useState([]),[N,z]=o.useState("gpt-4o-mini");o.useEffect(()=>{r.current&&(r.current.scrollTop=r.current.scrollHeight)},[f]),o.useEffect(()=>{(async()=>{console.log("[WorkflowChat] Fetching installed nodes");const a=await _e();console.log("[WorkflowChat] Received installed nodes:",a),L(a)})()},[]);const $=async s=>{try{const a=await T.fetchMessages(s);g(a)}catch(a){console.error("Error fetching messages:",a)}};o.useEffect(()=>{let s=localStorage.getItem("sessionId");s?(E(s),$(s)):(s=S(),E(s),localStorage.setItem("sessionId",s))},[]),o.useEffect(()=>{const s=()=>{const a=I.canvas.selected_nodes;if(Object.keys(a??{}).length){const d=Object.values(a)[0];c(d)}else c(null)};return document.addEventListener("click",s),()=>{document.removeEventListener("click",s)}},[]),o.useEffect(()=>{const s=a=>{document.documentElement.style.setProperty("--mouse-x",`${a.clientX}px`),document.documentElement.style.setProperty("--mouse-y",`${a.clientY}px`)};return document.addEventListener("mousemove",s),()=>{document.removeEventListener("mousemove",s)}},[]);const H=s=>{n(s.target.value)},B=async()=>{if(i.trim()===""&&!l||!_)return;j(!0),v(i);const s=S(),a={id:S(),role:"user",content:i,trace_id:s};g(d=>[...d,a]),n("");try{const d={type:"model_select",data:[N]};for await(const k of T.streamInvokeServer(_,i,m.map(y=>y.file),null,d,s)){const y={id:S(),role:"ai",content:JSON.stringify(k),type:k.type,format:k.format,finished:k.finished,name:"Assistant"};g(D=>D[D.length-1].role==="ai"?[...D.slice(0,-1),y]:[...D,y]),k.finished&&j(!1)}}catch(d){console.error("Error sending message:",d),j(!1)}finally{w([])}},J=s=>{s.metaKey&&s.key==="Enter"&&B()},X=()=>{g([]),localStorage.removeItem("sessionId");const s=S();E(s),localStorage.setItem("sessionId",s)},Z=s=>{n(s)},V=async(s,a)=>{if(!_||!l)return;j(!0);const d=S(),k={id:S(),role:"user",content:l.comfyClass||l.type,trace_id:d};g(y=>[...y,k]);try{for await(const y of T.streamInvokeServer(_,l.comfyClass||l.type,[],s,a,d)){const D={id:S(),role:"ai",content:JSON.stringify(y),format:y.format,finished:y.finished,name:"Assistant"};g(P=>P[P.length-1].role==="ai"?[...P.slice(0,-1),D]:[...P,D]),y.finished&&j(!1)}}catch(y){console.error("Error sending message:",y),j(!1)}},q=s=>{console.log("[WorkflowChat] Adding new message:",s),g(a=>{const d=[...a,s];return console.log("[WorkflowChat] Updated messages:",d),d})},Y=s=>{M(!0),s.preventDefault()};o.useEffect(()=>{const s=d=>{if(!A)return;const k=window.innerWidth-d.clientX,y=Math.min(Math.max(300,k),window.innerWidth*.8);W(y)},a=()=>{M(!1)};return A&&(document.addEventListener("mousemove",s),document.addEventListener("mouseup",a)),()=>{document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",a)}},[A]);const Q=s=>{const a=Array.from(s).map(d=>({id:Math.random().toString(36).substr(2,9),file:d,preview:URL.createObjectURL(d)}));w(d=>[...d,...a])},ee=s=>{w(a=>a.filter(k=>k.id!==s))};return F.useEffect(()=>()=>{m.forEach(s=>URL.revokeObjectURL(s.preview))},[m]),o.useEffect(()=>{h&&u&&(V("node_explain"),u())},[h]),e.jsxs("div",{className:`fixed top-0 right-0 h-full shadow-lg bg-white
                      transition-all duration-300 ease-in-out hover:shadow-xl text-gray-700`,style:{display:p?"block":"none",width:`${O}px`},children:[e.jsx("div",{className:"absolute left-0 top-0 bottom-0 w-1 cursor-ew-resize hover:bg-gray-300 active:bg-gray-400",onMouseDown:Y}),e.jsxs("div",{className:"flex h-full flex-col",children:[e.jsx(he,{onClose:t,onClear:X,hasMessages:f.length>0}),e.jsx("div",{children:x.map(s=>e.jsx("div",{children:s.name},s.name))}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4 scroll-smooth",ref:r,children:e.jsx(ke,{messages:f,latestInput:b,onOptionClick:Z,installedNodes:x,onAddMessage:q,loading:C})}),e.jsxs("div",{className:"border-t px-4 py-3 border-gray-200 bg-white sticky bottom-0",children:[l&&e.jsx(ge,{nodeInfo:l,onSendWithIntent:V,loading:C}),e.jsx(pe,{input:i,loading:C,onChange:H,onSend:B,onKeyPress:J,onUploadImages:Q,uploadedImages:m,onRemoveImage:ee,selectedModel:N,onModelChange:z})]})]})]})}export{De as default};
