import{j as e}from"./vendor-markdown-Dek94WS0.js";import{r as j}from"./vendor-react-V04_Axys.js";import{r as Ue,g as qe,m as Ke,i as Ye}from"./workflowChat-D65lpGB9.js";import{a as Q,u as Ne,W as ye,g as Je}from"./message-components-BUataGaC.js";import"./input.js";import"./App-HR12H20G.js";function Qe(o,n){try{if(!o)return console.error("Invalid prompt_output: ",o),o;for(const s of n){if(!o[s.nodeId]){console.error(`Node with ID ${s.nodeId} not found`);continue}if(!o[s.nodeId].inputs){console.error(`Inputs not found for node with ID ${s.nodeId}`);continue}o[s.nodeId].inputs[s.paramName]=s.paramValue}return o}catch(s){return console.error("Error updating prompt:",s),o}}async function Xe(o){const n=await Q.graphToPrompt(),s=Qe(n.output,o);console.log("queuePrompt updated_prompt:",s);const m={prompt:s,client_id:Q.api.clientId,extra_data:{extra_pageinfo:{workflow:n.workflow}}};console.debug("queuePrompt request_body.prompt:",s);const h=await Ue(m);return console.debug("queuePrompt response:",h),h}function we(o){const n=document.createElement("canvas"),s=n.getContext("2d");if(n.width=512,n.height=512,s){s.fillStyle="#f8d7da",s.fillRect(0,0,n.width,n.height),s.strokeStyle="#dc3545",s.lineWidth=4,s.strokeRect(10,10,n.width-20,n.height-20),s.fillStyle="#dc3545",s.beginPath(),s.arc(n.width/2,150,50,0,2*Math.PI),s.fill(),s.fillStyle="white",s.font="bold 80px Arial",s.textAlign="center",s.textBaseline="middle",s.fillText("!",n.width/2,150),s.fillStyle="#721c24",s.font="20px Arial",s.textAlign="center",s.textBaseline="middle";const m=n.width-60,h=30,l=o.split(" ");let x="",f=250;for(let p=0;p<l.length;p++){const S=x+l[p]+" ";s.measureText(S).width>m&&p>0?(s.fillText(x,n.width/2,f),x=l[p]+" ",f+=h):x=S}s.fillText(x,n.width/2,f)}return n.toDataURL("image/png")}async function Ze(o){try{if(!o||o==="")return console.log("No prompt ID provided"),{1:[we("Fail to generate prompt ID")]};const n=await qe(o);if(!n||!n[o])return console.log("Not finished for prompt ID:",o),{};const s=n[o];if(s.status&&s.status.status_str==="error"){console.error("Error for prompt ID:",o);const h=s.status.messages;if(h&&h.length>0){const l=h[h.length-1];if(l&&l.length>0){const x=l[0];return{1:[we(x)]}}}}const m={};if(s.outputs)for(const h in s.outputs){const l=s.outputs[h];if(l&&l.images){m[h]=[];for(const x of l.images)x&&x.filename&&x.type&&m[h].push(Q.graph._nodes_by_id[h].imgs[0].currentSrc);console.log("outputImages for nodeId:",h,m[h])}}return m}catch(n){throw console.error("Error getting output images from prompt:",n),n}}function et(){const o=Object.values(Q.graph._nodes_by_id),n=[],s=[];for(const m of o)m.type==="SaveImage"?n.push(m.id):m.type==="PreviewImage"&&s.push(m.id);if(console.log("saveNodeIds:",n),console.log("previewNodeIds:",s),n.length===0&&s.length===0)throw new Error("No SaveImage or PreviewImage node found, please add one to the graph");return n.length===1?n[0]:n.length==0&&s.length===1?s[0]:null}async function tt(o,n){const s=await Ze(o);return Object.keys(s).length===0?null:s[n.toString()]&&s[n.toString()].length>0?s[n.toString()][0]:null}const st=({selectedNodes:o,handleParamSelect:n,selectedParams:s,handleNext:m,handleClose:h})=>e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-4",children:[e.jsxs("div",{className:"mb-4 border-b pb-2 flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-base font-medium text-gray-800",children:"Select Parameters for Testing"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Choose the parameters you want to include in your batch test"})]}),e.jsx("button",{className:"text-gray-400 hover:text-gray-600",onClick:h,children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),o.map((l,x)=>{const f=l.title||"Unknown Node",p=l.widgets||[];return e.jsxs("div",{className:"border rounded-md mb-4 overflow-hidden",children:[e.jsx("div",{className:"bg-gray-50 px-3 py-2 text-sm font-medium text-gray-700 border-b",children:f}),e.jsx("div",{className:"p-4 space-y-3",children:e.jsx("div",{className:"flex items-center gap-3 flex-wrap",children:p.map((S,v)=>{const P=S.name;return e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:`w-5 h-5 rounded-full border flex items-center justify-center ${s[P]?"border-red-500 bg-red-100":"border-gray-300"}`,onClick:I=>n(P,I),children:s[P]&&e.jsx("div",{className:"w-3 h-3 rounded-full bg-red-500"})}),e.jsx("span",{className:"ml-2 text-gray-700 text-xs",children:P})]},`widget-${v}`)})})})]},`node-${x}`)}),e.jsx("div",{className:"mt-6 flex justify-center",children:e.jsx("button",{onClick:l=>m(l),className:"px-3 py-1.5 text-xs bg-pink-200 text-pink-700 rounded-md hover:bg-pink-300 transition-colors",children:"Next"})})]}),rt=({selectedNodes:o,paramTestValues:n,selectedParams:s,updateParamTestValues:m,toggleDropdown:h,openDropdowns:l,handleTestValueSelect:x,searchTerms:f,handleSearch:p,handleSelectAll:S,handleNext:v,handlePrevious:P,handleClose:I,inputValues:R,setInputValues:B,textInputs:z,handleTextInputChange:L,handleAddTextInput:_,handleRemoveTextInput:b,openAiWritingModal:N})=>{const $=(w,A,V,K=0)=>{w=isNaN(w)?0:w,A=isNaN(A)?100:A,V=isNaN(V)||V<=0?1:V,A<w&&(A=w);const g=Math.floor((A-w)/V)+1;if(g<=1)return[w];const O=[];let Y=w;if(g<=10)for(;Y<=A&&O.length<=10;){const i=Math.pow(10,K),F=Math.round(Y*i)/i;O.push(F),Y+=V}else{const F=(A-w)/9;for(let C=0;C<=9;C++){const y=w+F*C,u=Math.pow(10,K),T=Math.round(y*u)/u;O.push(T)}}return O};return e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-4",children:[e.jsxs("div",{className:"mb-4 border-b pb-2 flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-base font-medium text-gray-800",children:"Parameter Options"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Configure the test values for each parameter"})]}),e.jsx("button",{className:"text-gray-400 hover:text-gray-600",onClick:I,children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),o.length>0?o.map((w,A)=>{const V=w.widgets||{},K=Object.values(V),g=w.id;return e.jsxs("div",{className:"border rounded-md mb-4 overflow-hidden",children:[e.jsxs("div",{className:"bg-gray-50 px-3 py-2 text-xs font-medium text-gray-700 border-b flex justify-between items-center",children:[e.jsxs("span",{children:[w.type," (ID: ",g,")"]}),e.jsx("button",{className:"text-gray-400 hover:text-gray-600",onClick:O=>I(O,A),children:e.jsx("svg",{className:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),e.jsx("div",{className:"p-4 space-y-4",children:K.map((O,Y)=>{const i=O.name;if(!s[i])return null;const F=`${g}_${i}`;if(O.type==="customtext"||O.type.toLowerCase().includes("text")){const C=z[F]||[""];return e.jsxs("div",{className:"border-b pb-3",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsxs("label",{className:"text-xs font-medium text-gray-700",children:[i,":"]}),e.jsxs("button",{className:"px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs flex items-center hover:bg-blue-200 transition-colors",onClick:()=>N(g,i),children:[e.jsx("svg",{className:"w-3 h-3 mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"})}),"AI Writing"]})]}),e.jsx("div",{className:"space-y-2",children:C.map((y,u)=>e.jsxs("div",{className:"flex items-start",children:[e.jsx("textarea",{className:"flex-1 border border-gray-300 rounded p-2 text-xs resize-y",rows:2,placeholder:"Enter text...",value:y,onChange:T=>L(g,i,u,T.target.value)}),e.jsx("button",{className:"ml-2 text-red-500 hover:text-red-700",onClick:()=>b(g,i,u),title:"Remove",children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]},u))}),e.jsxs("button",{className:"mt-2 px-2 py-1 border border-dashed border-gray-300 rounded text-xs text-gray-600 hover:bg-gray-50 flex items-center",onClick:()=>_(g,i),children:[e.jsx("svg",{className:"w-3 h-3 mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 6v6m0 0v6m0-6h6m-6 0H6"})}),"Add Text"]})]},Y)}if(O.type==="number"){const C=O.options?.min||0,y=O.options?.max||100,u=(O.options?.step||10)/10,T=O.options?.precision||0,H=$(C,y,u,T),U=R[F]||{min:C.toString(),max:y.toString(),step:u.toString()};return e.jsxs("div",{className:"border-b pb-3",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("label",{className:"text-xs font-medium text-gray-700",children:[i,":"]}),e.jsx("div",{className:"w-4"})]}),e.jsxs("div",{className:"flex space-x-2 items-center",children:[e.jsx("label",{className:"text-xs text-gray-600",children:"Min"}),e.jsx("input",{type:"text",className:"w-12 h-6 border border-gray-300 rounded text-xs px-2",value:U.min,onClick:E=>{E.preventDefault(),E.stopPropagation()},onChange:E=>{E.preventDefault(),E.stopPropagation();const W=E.target.value;if(B(D=>({...D,[F]:{...D[F],min:W}})),W===""||!isNaN(parseFloat(W))){const D=W===""?0:parseFloat(W),J=parseFloat(U.max||y.toString()),te=parseFloat(U.step||u.toString()),X=$(D,J,te,T);m(g,i,X)}}}),e.jsx("label",{className:"text-xs text-gray-600",children:"Max"}),e.jsx("input",{type:"text",className:"w-12 h-6 border border-gray-300 rounded text-xs px-2",value:U.max,onClick:E=>{E.preventDefault(),E.stopPropagation()},onChange:E=>{E.preventDefault(),E.stopPropagation();const W=E.target.value;if(B(D=>({...D,[F]:{...D[F],max:W}})),W===""||!isNaN(parseFloat(W))){const D=parseFloat(U.min||C.toString()),J=W===""?D:parseFloat(W),te=parseFloat(U.step||u.toString()),X=$(D,J,te,T);m(g,i,X)}}}),e.jsx("label",{className:"text-xs text-gray-600",children:"Step"}),e.jsx("input",{type:"text",className:"w-12 h-6 border border-gray-300 rounded text-xs px-2",value:U.step,onClick:E=>{E.preventDefault(),E.stopPropagation()},onChange:E=>{E.preventDefault(),E.stopPropagation();const W=E.target.value;if(B(D=>({...D,[F]:{...D[F],step:W}})),W===""||!isNaN(parseFloat(W))&&parseFloat(W)>0){const D=parseFloat(U.min||C.toString()),J=parseFloat(U.max||y.toString()),te=W===""?1:parseFloat(W),X=$(D,J,te,T);m(g,i,X)}}})]}),e.jsxs("div",{className:"mt-1",children:[e.jsx("label",{className:"text-xs text-gray-600",children:"Test values"}),e.jsx("div",{className:"mt-1 flex flex-wrap gap-1",children:(n[g]?.[i]||H).map((E,W)=>e.jsxs("div",{className:"px-2 py-0.5 bg-blue-100 text-blue-800 rounded-md flex items-center text-xs cursor-pointer hover:bg-blue-200",onClick:D=>{D.stopPropagation(),x(g,i,E,D)},children:[e.jsx("span",{children:E}),e.jsx("svg",{className:"w-4 h-4 ml-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})]},W))})]}),e.jsx("div",{className:"mt-1",children:e.jsx("p",{className:"text-xs text-gray-500",children:"Values are distributed evenly between Min and Max (max 10 values)"})})]},Y)}else if(O.type==="combo"){const C=O.options?.values||[],y=`${g}_${i}`;return e.jsxs("div",{className:"border-b pb-3",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("label",{className:"text-xs font-medium text-gray-700",children:i}),e.jsxs("div",{className:"relative dropdown-container",children:[e.jsxs("button",{className:"appearance-none border border-gray-300 rounded px-2 py-0.5 pr-6 text-xs flex items-center bg-white text-gray-700",onClick:u=>{u.preventDefault(),u.stopPropagation(),h(g,i,u)},"data-dropdown":y,children:[e.jsx("span",{children:(n[g]?.[i]||[]).length>0?`${i}: ${(n[g]?.[i]||[]).length} selected`:`Select ${i}`}),e.jsx("div",{className:"ml-2",children:e.jsx("svg",{className:"fill-current h-4 w-4",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",children:e.jsx("path",{d:"M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"})})})]}),l[y]&&e.jsxs("div",{className:"absolute z-[9999] mt-1 w-64 bg-white border border-gray-300 rounded-md shadow-lg dropdown-menu",style:{position:"fixed",top:typeof l[y]=="object"?`${l[y].y}px`:"0px",left:typeof l[y]=="object"?`${l[y].x}px`:"0px",maxHeight:"300px",overflowY:"auto"},children:[e.jsx("div",{className:"p-2 border-b sticky top-0 bg-white",children:e.jsx("input",{type:"text",className:"w-full px-2 py-0.5 text-xs border border-gray-300 rounded",placeholder:"Search...",value:f[y]||"",onChange:u=>{u.preventDefault(),u.stopPropagation(),p(g,i,u.target.value)},onClick:u=>{u.preventDefault(),u.stopPropagation()},autoFocus:!0})}),e.jsxs("div",{className:"px-3 py-1.5 bg-gray-50 border-b cursor-pointer text-xs flex items-center text-gray-700 hover:bg-gray-100",onClick:u=>{u.preventDefault(),u.stopPropagation();const T=C.filter(H=>!f[y]||H.toLowerCase().includes((f[y]||"").toLowerCase()));S(g,i,T)},children:[e.jsx("div",{className:`w-4 h-4 mr-2 border rounded-sm flex items-center justify-center ${C.length>0&&(n[g]?.[i]||[]).length===C.length?"bg-blue-500 border-blue-500":(n[g]?.[i]||[]).length>0?"bg-blue-500 border-blue-500 opacity-50":"border-gray-300"}`,children:(n[g]?.[i]||[]).length>0&&e.jsx("svg",{className:"w-3 h-3 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})}),e.jsx("span",{className:"font-medium",children:C.length>0&&(n[g]?.[i]||[]).length===C.length?"Deselect All":"Select All"})]}),e.jsxs("div",{className:"max-h-60 overflow-y-auto",children:[C.filter(u=>!f[y]||u.toLowerCase().includes((f[y]||"").toLowerCase())).map((u,T)=>e.jsxs("div",{className:"px-3 py-1.5 hover:bg-gray-100 cursor-pointer text-xs flex items-center text-gray-700",onClick:H=>{H.preventDefault(),H.stopPropagation(),x(g,i,u,H)},children:[e.jsx("div",{className:`w-4 h-4 mr-2 border rounded-sm flex items-center justify-center ${(n[g]?.[i]||[]).includes(u)?"bg-blue-500 border-blue-500":"border-gray-300"}`,children:(n[g]?.[i]||[]).includes(u)&&e.jsx("svg",{className:"w-3 h-3 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})}),e.jsx("span",{className:"whitespace-normal overflow-hidden text-ellipsis",children:u})]},T)),C.filter(u=>!f[y]||u.toLowerCase().includes((f[y]||"").toLowerCase())).length===0&&e.jsx("div",{className:"px-3 py-4 text-sm text-gray-500 text-center",children:"No matching options"})]})]})]})]}),e.jsxs("div",{className:"mt-2",children:[e.jsx("label",{className:"text-xs text-gray-600",children:"Test values"}),e.jsxs("div",{className:"mt-1 flex flex-wrap gap-1",children:[(n[g]?.[i]||[]).map((u,T)=>e.jsxs("div",{className:"px-2 py-0.5 bg-blue-100 text-blue-800 rounded-md flex items-center text-xs",children:[e.jsx("span",{children:u}),e.jsx("svg",{className:"w-4 h-4 ml-1 cursor-pointer hover:text-blue-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",onClick:H=>{H.preventDefault(),H.stopPropagation(),x(g,i,u,H)},children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})]},T)),e.jsxs("button",{className:"px-2 py-0.5 border border-dashed border-blue-300 text-blue-600 rounded-md text-xs flex items-center hover:bg-blue-50",onClick:u=>{u.preventDefault(),u.stopPropagation();const T=`${i}${(n[g]?.[i]||[]).length+1}`;m(g,i,[...n[g]?.[i]||[],T])},children:[e.jsx("svg",{className:"w-4 h-4 mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 6v6m0 0v6m0-6h6m-6 0H6"})}),e.jsx("span",{children:"Add"})]})]})]})]},Y)}else return e.jsxs("div",{className:"border-b pb-3",children:[e.jsx("div",{className:"flex justify-between items-center",children:e.jsx("label",{className:"text-xs font-medium text-gray-700",children:i})}),e.jsxs("div",{className:"mt-2",children:[e.jsx("label",{className:"text-xs text-gray-600",children:"Test values"}),e.jsxs("div",{className:"mt-1 flex flex-wrap gap-1",children:[(n[g]?.[i]||[]).map((C,y)=>e.jsxs("div",{className:"px-2 py-0.5 bg-blue-100 text-blue-800 rounded-md flex items-center text-xs",children:[e.jsx("span",{children:C}),e.jsx("svg",{className:"w-4 h-4 ml-1 cursor-pointer hover:text-blue-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",onClick:u=>{u.preventDefault(),u.stopPropagation(),x(g,i,C,u)},children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})]},y)),e.jsxs("button",{className:"px-2 py-0.5 border border-dashed border-blue-300 text-blue-600 rounded-md text-xs flex items-center hover:bg-blue-50",onClick:C=>{C.preventDefault(),C.stopPropagation();const y=`${i}${(n[g]?.[i]||[]).length+1}`;m(g,i,[...n[g]?.[i]||[],y])},children:[e.jsx("svg",{className:"w-4 h-4 mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 6v6m0 0v6m0-6h6m-6 0H6"})}),e.jsx("span",{children:"Add"})]})]})]})]},Y)})})]},A)}):e.jsx("div",{className:"border rounded-md mb-4 p-4 text-center text-gray-500",children:"No nodes selected. Please select a node in the workflow to configure parameters."}),e.jsxs("div",{className:"mt-6 flex justify-between",children:[e.jsx("button",{onClick:w=>P(w),className:"px-3 py-1.5 text-xs bg-gray-100 text-gray-800 rounded-md hover:bg-gray-200 transition-colors",children:"Previous"}),e.jsx("button",{onClick:w=>v(w),className:"px-3 py-1.5 text-xs bg-pink-200 text-pink-700 rounded-md hover:bg-pink-300 transition-colors",children:"Next"})]})]})},nt=({selectedNodes:o,paramTestValues:n,selectedParams:s,totalCount:m,errorMessage:h,handlePrevious:l,handleStartGeneration:x,handleClose:f})=>{const[p,S]=j.useState([]),[v,P]=j.useState(null),[I,R]=j.useState(!1);Ne();const B=()=>{const L=Object.values(Q.graph._nodes_by_id),_=[],b=[];for(const $ of L)$.type==="SaveImage"?_.push($.id):$.type==="PreviewImage"&&b.push($.id);const N=[..._,...b];S(N),N.length===1?P(N[0]):N.length>1&&(R(!0),P(null))};j.useEffect(()=>{B()},[]),j.useEffect(()=>{const L=()=>{if(!Q.canvas.selected_nodes)return;const _=Object.values(Q.canvas.selected_nodes);if(_.length===0)return;const b=_[0];b&&(b.type==="SaveImage"||b.type==="PreviewImage")&&(console.log("Selected image node:",b.id),P(b.id))};return document.addEventListener("click",L),()=>{document.removeEventListener("click",L)}},[]);const z=L=>{if(L&&(L.preventDefault(),L.stopPropagation()),p.length>1&&!v){R(!0);return}x(L,v||void 0)};return e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-4",children:[e.jsxs("div",{className:"mb-4 border-b pb-2 flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-base font-medium text-gray-800",children:"Confirm Test Configuration"}),e.jsxs("p",{className:"text-xs text-gray-500",children:["In the selected parameter combinations, there are ",m," total runs. Each run will generate a separate image."]})]}),e.jsx("button",{className:"text-gray-400 hover:text-gray-600",onClick:f,children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),I&&p.length>1&&e.jsx("div",{className:"mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-md text-amber-600 text-xs",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx("div",{className:"flex-shrink-0 mt-0.5",children:e.jsx("svg",{className:"h-3 w-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})})}),e.jsx("div",{className:"ml-2",children:v===null?`Multiple SaveImage and PreviewImage nodes detected with IDs ${p.join(",")}. Please click the node on canvas.`:`Current node ID is ${v}, please click Start Generation again`})]})}),h&&e.jsx("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-md text-red-600 text-xs",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx("div",{className:"flex-shrink-0 mt-0.5",children:e.jsx("svg",{className:"h-3 w-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})})}),e.jsx("div",{className:"ml-2",children:h})]})}),o.length>0?o.map((L,_)=>{const b=L.type||"Unknown Node",N=L.widgets||[],$=L.id;return e.jsxs("div",{className:"border rounded-md mb-4 overflow-hidden",children:[e.jsxs("div",{className:"bg-gray-50 px-3 py-2 text-xs font-medium text-gray-700 border-b",children:[b," (ID: ",$,")"]}),e.jsx("div",{className:"p-4 space-y-3",children:N.map((w,A)=>{const V=w.name;if(!s[V])return null;const K=n[$]?.[V]||[],g=Array.isArray(K)?`[${K.join(", ")}]`:JSON.stringify(K);return e.jsxs("div",{className:A<N.length-1?"flex justify-between items-center border-b pb-2":"flex justify-between items-center",children:[e.jsx("label",{className:"font-medium text-gray-700 text-xs",children:V}),e.jsx("div",{className:"flex space-x-2 items-center",children:e.jsx("input",{type:"text",className:"w-64 h-7 border border-gray-300 rounded text-xs px-2 bg-gray-50 cursor-not-allowed text-gray-500",readOnly:!0,disabled:!0,value:g,onClick:O=>O.preventDefault()})})]},A)})})]},_)}):e.jsx("div",{className:"border rounded-md mb-4 p-4 text-center text-gray-500 text-xs",children:"No nodes selected. Please select a node in the workflow to configure parameters."}),e.jsxs("div",{className:"mt-6 flex justify-between",children:[e.jsx("button",{onClick:L=>l(L),className:"px-3 py-1.5 text-xs bg-gray-100 text-gray-800 rounded-md hover:bg-gray-200 transition-colors",children:"Previous"}),e.jsx("button",{onClick:L=>z(L),className:`px-3 py-1.5 text-xs rounded-md transition-colors ${p.length>1&&!v?"bg-gray-200 text-gray-500 cursor-not-allowed":"bg-pink-200 text-pink-700 hover:bg-pink-300"}`,disabled:p.length>1&&!v,children:"Start Generation"})]})]})},ot=({selectedNodes:o,paramTestValues:n,selectedParams:s,totalCount:m,completedCount:h,errorMessage:l,handleClose:x,setIsProcessing:f,setCurrentScreen:p})=>{const S=v=>{v.preventDefault(),v.stopPropagation(),Ke({clear:!0}),Ye(),f(!1),p(2)};return e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-4 relative",children:[e.jsx("div",{className:"absolute inset-0 bg-gray-500 bg-opacity-30 flex flex-col items-center justify-center z-10",children:e.jsxs("div",{className:"text-center text-gray-800 bg-white p-4 rounded-lg shadow-lg",children:[e.jsx("div",{className:"mb-2 text-sm font-medium",children:"Processing..."}),e.jsxs("div",{className:"text-xs mb-3",children:["Completed ",h," of ",m," runs"]}),e.jsx("div",{className:"w-48 h-2 bg-gray-200 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-pink-500 transition-all duration-200",style:{width:`${h/m*100}%`}})}),e.jsxs("div",{className:"mt-2 text-xs text-gray-600",children:["Already generated ",h," images"]}),e.jsx("button",{onClick:S,className:"mt-4 px-3 py-1.5 text-xs bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors",children:"Cancel"})]})}),e.jsxs("div",{className:"mb-4 border-b pb-2 flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-base font-medium text-gray-800",children:"Confirm Test Configuration"}),e.jsxs("p",{className:"text-xs text-gray-500",children:["In the selected parameter combinations, there are ",m," total runs. Each run will generate a separate image."]})]}),e.jsx("button",{className:"text-gray-400 hover:text-gray-600",onClick:x,children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),l&&e.jsx("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-md text-red-600 text-xs",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx("div",{className:"flex-shrink-0 mt-0.5",children:e.jsx("svg",{className:"h-3 w-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})})}),e.jsx("div",{className:"ml-2",children:l})]})}),o.length>0?o.map((v,P)=>{const I=v.type||"Unknown Node",R=v.widgets||[],B=v.id;return e.jsxs("div",{className:"border rounded-md mb-4 overflow-hidden",children:[e.jsxs("div",{className:"bg-gray-50 px-3 py-2 text-xs font-medium text-gray-700 border-b",children:[I," (ID: ",B,")"]}),e.jsx("div",{className:"p-4 space-y-3",children:R.map((z,L)=>{const _=z.name;if(!s[_])return null;const b=n[B]?.[_]||[],N=Array.isArray(b)?`[${b.join(", ")}]`:JSON.stringify(b);return e.jsxs("div",{className:L<R.length-1?"flex justify-between items-center border-b pb-2":"flex justify-between items-center",children:[e.jsx("label",{className:"font-medium text-gray-700",children:_}),e.jsx("div",{className:"flex space-x-2 items-center",children:e.jsx("input",{type:"text",className:"w-64 h-7 border border-gray-300 rounded text-sm px-2 bg-gray-50 cursor-not-allowed text-gray-500",readOnly:!0,disabled:!0,value:N,onClick:$=>$.preventDefault()})})]},L)})})]},P)}):e.jsx("div",{className:"border rounded-md mb-4 p-4 text-center text-gray-500",children:"No nodes selected. Please select a node in the workflow to configure parameters."})]})},at=({generatedImages:o,selectedImageIndex:n,handleSelectImage:s,handleApplySelected:m,handlePrevious:h,handleClose:l,currentPage:x,handlePageChange:f,imagesPerPage:p,notificationVisible:S,modalVisible:v,modalImageUrl:P,openImageModal:I,closeImageModal:R})=>{const B=Math.ceil(o.length/p),z=(x-1)*p,L=Math.min(z+p,o.length),_=o.slice(z,L);return e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-4",children:[e.jsxs("div",{className:"mb-4 border-b pb-2 flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-base font-medium text-gray-800",children:"Generation Complete"}),e.jsxs("p",{className:"text-xs text-gray-500",children:["All ",o.length," images have been generated."]})]}),e.jsx("button",{className:"text-gray-400 hover:text-gray-600",onClick:l,children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),S&&e.jsx("div",{className:"fixed top-4 right-4 bg-green-100 border-l-4 border-green-500 text-green-700 p-3 shadow-md rounded animate-fade-in-out z-50",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"py-1",children:e.jsx("svg",{className:"h-4 w-4 text-green-500 mr-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})}),e.jsx("p",{className:"text-xs",children:"Parameters has been applied."})]})}),v&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50",onClick:R,children:e.jsxs("div",{className:"bg-white rounded-lg p-2 max-w-4xl max-h-[90vh] relative",onClick:b=>b.stopPropagation(),children:[e.jsx("button",{className:"absolute top-2 right-2 text-gray-700 hover:text-gray-900 rounded-full hover:bg-gray-200 p-1",onClick:R,children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),e.jsx("div",{className:"overflow-auto max-h-[calc(90vh-4rem)]",children:e.jsx("img",{src:P,alt:"Enlarged image",className:"max-w-full h-auto"})})]})}),e.jsx("div",{className:"grid grid-cols-3 gap-4 mb-6",children:_.map((b,N)=>{const $=z+N;return e.jsxs("div",{className:`relative rounded-lg overflow-hidden border ${n===$?"border-pink-500 ring-2 ring-pink-300":"border-gray-200"}`,onClick:w=>s($,w),children:[e.jsx("button",{className:"absolute top-2 right-2 bg-white bg-opacity-75 rounded-full p-0.5 text-gray-600 hover:text-gray-900 shadow-sm z-10",onClick:w=>I(b.url,w),children:e.jsx("svg",{className:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 4h-4m4 0l-5-5"})})}),e.jsx("div",{className:"aspect-square",children:e.jsx("img",{src:b.url,alt:`Generated image ${$+1}`,className:"w-full h-full object-cover"})}),e.jsx("div",{className:"p-2 text-xs text-gray-600 bg-white max-h-16 overflow-y-auto",children:Object.entries(b.params).filter(([w,A])=>w!=="nodeParams"&&typeof A!="object").map(([w,A])=>e.jsxs("div",{children:[w,": ",String(A)]},w))})]},$)})}),B>1&&e.jsxs("div",{className:"flex justify-center items-center space-x-2 mt-4 mb-4",children:[e.jsx("button",{onClick:b=>f(1,b),disabled:x===1,className:`px-2 py-1 rounded ${x===1?"text-gray-400 cursor-not-allowed":"text-gray-700 hover:bg-gray-100"}`,children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:[e.jsx("path",{fillRule:"evenodd",d:"M15.707 15.707a1 1 0 01-1.414 0l-5-5a1 1 0 010-1.414l5-5a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 010 1.414z",clipRule:"evenodd"}),e.jsx("path",{fillRule:"evenodd",d:"M8.707 15.707a1 1 0 01-1.414 0l-5-5a1 1 0 010-1.414l5-5a1 1 0 111.414 1.414L4.414 10l4.293 4.293a1 1 0 010 1.414z",clipRule:"evenodd"})]})}),e.jsx("button",{onClick:b=>f(x-1,b),disabled:x===1,className:`px-2 py-1 rounded ${x===1?"text-gray-400 cursor-not-allowed":"text-gray-700 hover:bg-gray-100"}`,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z",clipRule:"evenodd"})})}),e.jsxs("div",{className:"px-2 py-1 text-xs text-gray-800",children:["Page ",x," of ",B]}),e.jsx("button",{onClick:b=>f(x+1,b),disabled:x===B,className:`px-2 py-1 rounded ${x===B?"text-gray-400 cursor-not-allowed":"text-gray-700 hover:bg-gray-100"}`,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z",clipRule:"evenodd"})})}),e.jsx("button",{onClick:b=>f(B,b),disabled:x===B,className:`px-2 py-1 rounded ${x===B?"text-gray-400 cursor-not-allowed":"text-gray-700 hover:bg-gray-100"}`,children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:[e.jsx("path",{fillRule:"evenodd",d:"M4.293 15.707a1 1 0 001.414 0l5-5a1 1 0 000-1.414l-5-5a1 1 0 00-1.414 1.414L8.586 10 4.293 14.293a1 1 0 000 1.414z",clipRule:"evenodd"}),e.jsx("path",{fillRule:"evenodd",d:"M11.293 15.707a1 1 0 001.414 0l5-5a1 1 0 000-1.414l-5-5a1 1 0 00-1.414 1.414L15.586 10l-4.293 4.293a1 1 0 000 1.414z",clipRule:"evenodd"})]})})]}),e.jsxs("div",{className:"mt-6 flex justify-between",children:[e.jsx("button",{onClick:b=>h(b),className:"px-3 py-1.5 text-xs bg-gray-100 text-gray-800 rounded-md hover:bg-gray-200 transition-colors",children:"Previous"}),e.jsx("button",{onClick:b=>m(b),className:"px-3 py-1.5 text-xs bg-pink-200 text-pink-700 rounded-md hover:bg-pink-300 transition-colors",disabled:n===null,children:"Apply Selected"})]})]})},lt=({visible:o,aiWritingModalText:n,setAiWritingModalText:s,aiGeneratedTexts:m,aiSelectedTexts:h,aiWritingLoading:l,aiWritingError:x,handleAiWriting:f,toggleTextSelection:p,addSelectedTexts:S,onClose:v})=>o?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg w-full max-w-2xl max-h-[90vh] overflow-hidden",children:[e.jsxs("div",{className:"p-4 border-b flex justify-between items-center",children:[e.jsx("h3",{className:"text-lg font-medium",children:"AI Writing Assistant"}),e.jsx("button",{className:"text-gray-400 hover:text-gray-600",onClick:v,children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("p",{className:"text-sm text-gray-600 mb-2",children:"Enter text and AI will generate variations"}),e.jsx("textarea",{className:"w-full border border-gray-300 rounded-md p-2 text-sm",rows:3,placeholder:"Enter some text here...",value:n,onChange:P=>s(P.target.value)}),e.jsx("button",{className:"mt-2 px-4 py-2 bg-blue-100 text-blue-700 rounded-md text-sm flex items-center hover:bg-blue-200 transition-colors",onClick:f,disabled:l,children:l?e.jsxs(e.Fragment,{children:[e.jsxs("svg",{className:"animate-spin -ml-1 mr-2 h-4 w-4 text-blue-700",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Generating..."]}):e.jsx(e.Fragment,{children:"Generate"})})]}),x&&e.jsx("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-md text-red-600 text-sm",children:x}),m.length>0&&e.jsxs("div",{className:"mb-4",children:[e.jsx("p",{className:"text-sm font-medium mb-2",children:"Generated variations (select items to add):"}),e.jsx("div",{className:"space-y-2 max-h-[40vh] overflow-y-auto p-2",children:m.map((P,I)=>e.jsxs("div",{className:"flex items-start border border-gray-200 rounded-md p-2",children:[e.jsx("div",{className:"mr-2 mt-1",children:e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"checkbox",id:`text${I+1}`,checked:!!h[`text${I+1}`],onChange:()=>p(`text${I+1}`),className:"sr-only"}),e.jsx("div",{className:`h-4 w-4 rounded border ${h[`text${I+1}`]?"bg-blue-600 border-blue-600":"bg-white border-gray-300"} flex items-center justify-center`,onClick:()=>p(`text${I+1}`),children:h[`text${I+1}`]&&e.jsx("svg",{className:"h-3 w-3 text-white",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})})]})}),e.jsx("label",{htmlFor:`text${I+1}`,className:"text-sm text-gray-700 cursor-pointer flex-1",children:P})]},I))})]})]}),e.jsxs("div",{className:"p-4 border-t flex justify-end",children:[e.jsx("button",{className:"px-4 py-2 bg-gray-100 text-gray-700 rounded-md text-sm mr-2 hover:bg-gray-200 transition-colors",onClick:v,children:"Cancel"}),e.jsx("button",{className:"px-4 py-2 bg-blue-500 text-white rounded-md text-sm hover:bg-blue-600 transition-colors",onClick:S,disabled:Object.values(h).every(P=>!P),children:"Add Selected"})]})]})}):null,he=o=>{const n=[],s={};if(Object.keys(o).forEach(l=>{const x=parseInt(l),f=o[l]||{},p=Object.keys(f).filter(v=>f[v]&&f[v].length>0);if(p.length===0)return;const S=[[]];p.forEach(v=>{const P=f[v],I=[];S.forEach(R=>{P.forEach(B=>{const z=[...R,{nodeId:x,paramName:v,paramValue:String(B)}];I.push(z)})}),S.length=0,S.push(...I)}),s[l]=S}),Object.keys(s).length===0)return n;if(Object.keys(s).length===1){const l=Object.keys(s)[0];return s[l]}const m=Object.keys(s);let h=s[m[0]];for(let l=1;l<m.length;l++){const x=s[m[l]],f=[];h.forEach(p=>{x.forEach(S=>{f.push([...p,...S])})}),h=f}return h},it=(o,n)=>{const s={};s.nodeParams={};const m=he(o);return n<m.length&&m[n].forEach(l=>{const x=l.nodeId.toString(),f=l.paramName,p=l.paramValue;s.nodeParams[x]||(s.nodeParams[x]={}),s.nodeParams[x][f]=p,s[f]=p}),s},ct=`
  @keyframes highlight-pulse {
    0% { 
      box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5);
    }
    70% { 
      box-shadow: 0 0 0 15px rgba(59, 130, 246, 0);
    }
    100% { 
      box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
    }
  }
  
  .highlight-pulse {
    animation: highlight-pulse 1.5s infinite;
    border: 2px solid #3b82f6;
  }

  @keyframes fade-in-out {
    0% { opacity: 0; transform: translateY(-20px); }
    10% { opacity: 1; transform: translateY(0); }
    90% { opacity: 1; transform: translateY(0); }
    100% { opacity: 0; transform: translateY(-20px); }
  }
  
  .animate-fade-in-out {
    animation: fade-in-out 3s forwards;
  }
`,gt=({selectedNodes:o,visible:n,onClose:s})=>{const[m,h]=j.useState(0),[l,x]=j.useState({Steps:!0,CFG:!0,sampler_name:!0,threshold:!1,prompt:!1}),[f,p]=j.useState(!1),[S,v]=j.useState(!1),[P,I]=j.useState(0),[R,B]=j.useState(12),[z,L]=j.useState(null),[_,b]=j.useState(()=>Array(12).fill(null).map((t,r)=>({url:`https://source.unsplash.com/random/300x300?sig=${Math.random()}`,params:{step:r%3===0?5:r%3===1?10:15,sampler_name:"euler",cfg:1}}))),[N,$]=j.useState({}),[w,A]=j.useState({}),[V,K]=j.useState({}),[g,O]=j.useState({}),[Y,i]=j.useState(1),F=6,[C,y]=j.useState(null),[u,T]=j.useState(!1),[H,U]=j.useState(!1),[E,W]=j.useState(""),[D,J]=j.useState({}),[te,X]=j.useState(!1),[ce,pe]=j.useState(""),[ge,de]=j.useState([]),[ke,xe]=j.useState(!1),[fe,Ce]=j.useState(""),[be,Se]=j.useState(""),[Le,ae]=j.useState(null),[je,le]=j.useState({}),{dispatch:se}=Ne(),Me=async()=>{if(!ce.trim()){ae("Please enter some text to generate variations");return}xe(!0),ae(null),de([]),le({});try{const t=await ye.generateSDPrompts(ce);de(t);const r={};t.forEach((a,c)=>{r[`text${c+1}`]=!1}),le(r)}catch(t){console.error("Error generating text:",t),ae("Failed to generate text variations. Please try again.")}finally{xe(!1)}},Pe=(t,r,a,c)=>{const d=`${t}_${r}`;J(k=>{const G=[...k[d]||[]];return G[a]=c,{...k,[d]:G}});const M=[...D[d]||[]];M[a]=c,ee(t,r,M)},Ie=(t,r)=>{const a=`${t}_${r}`;J(d=>{const M=[...d[a]||[]];return M.push(""),{...d,[a]:M}});const c=[...D[a]||[],""];ee(t,r,c)},Ee=(t,r,a)=>{const c=`${t}_${r}`;J(M=>{const k=[...M[c]||[]];return k.splice(a,1),{...M,[c]:k}});const d=[...D[c]||[]];d.splice(a,1),ee(t,r,d)},$e=t=>{le(r=>({...r,[t]:!r[t]}))},De=()=>{const t=`${fe}_${be}`,r=Object.entries(je).filter(([c,d])=>d).map(([c])=>{const d=parseInt(c.replace("text",""))-1;return ge[d]});if(r.length===0)return;J(c=>{const d=[...c[t]||[]];return{...c,[t]:[...d,...r]}});const a=[...D[t]||[],...r];ee(fe,be,a),X(!1)},We=(t,r)=>{X(!0),Ce(t),Se(r),pe(""),de([]),le({}),xe(!1),ae(null)};j.useEffect(()=>{if(!o||o.length===0)return;const t={...N},r=o.map(c=>c.id.toString());Object.keys(t).forEach(c=>{r.includes(c)||delete t[c]}),o.forEach(c=>{const d=c.id.toString();t[d]||(t[d]={})}),JSON.stringify(t)!==JSON.stringify(N)&&$(t)},[o,N]),j.useEffect(()=>{se({type:"SET_SCREEN_STATE",payload:{currentScreen:m,isProcessing:f,isCompleted:S}})},[m,f,S,se]),j.useEffect(()=>{const t=document.createElement("style");return t.textContent=ct,document.head.appendChild(t),()=>{document.head.removeChild(t)}},[]),j.useEffect(()=>{const t=r=>{if(Object.values(w).some(a=>a)){const a=r.target,c=!!a.closest(".dropdown-menu"),d=!!a.closest("[data-dropdown]");!c&&!d&&A({})}};return document.addEventListener("mousedown",t),()=>{document.removeEventListener("mousedown",t)}},[w]);const ve=t=>{if(t&&(t.preventDefault(),t.stopPropagation()),m===1){const r=he(N);B(r.length)}y(null),h(r=>Math.min(r+1,2))},me=t=>{if(t&&(t.preventDefault(),t.stopPropagation()),y(null),S&&v(!1),m===1){const r=o.map(d=>d.id.toString()),a=Object.keys(N),c={...N};a.forEach(d=>{r.includes(d)||delete c[d]}),$(c)}h(r=>Math.max(r-1,0))},_e=(t,r)=>{r&&(r.preventDefault(),r.stopPropagation()),x(a=>({...a,[t]:!a[t]}))},Ae=(t,r,a)=>{a.preventDefault(),a.stopPropagation();const c=`${t}_${r}`;A(d=>{if(d[c]&&typeof d[c]=="object"?d[c].isOpen:!!d[c])return{...d,[c]:!1};{let k=0,G=0;if(a.currentTarget){const Z=a.currentTarget.getBoundingClientRect();k=Z.left,G=Z.bottom}else k=a.clientX,G=a.clientY+20;const ne=window.innerWidth,oe=250;return k+oe>ne&&(k=ne-oe-10),k<0&&(k=10),{...d,[c]:{isOpen:!0,x:k,y:G}}}})},ee=(t,r,a)=>{$(c=>{const d={...c};return d[t]||(d[t]={}),d[t][r]=a,d})},Oe=(t,r,a,c)=>{c&&(c.preventDefault(),c.stopPropagation()),$(d=>{const M={...d};M[t]||(M[t]={}),M[t][r]||(M[t][r]=[]);const k=M[t][r];return k.includes(a)?M[t][r]=k.filter(G=>G!==a):M[t][r]=[...k,a],M})},Be=(t,r,a)=>{const c=`${t}_${r}`;K(d=>({...d,[c]:a}))},Te=(t,r,a)=>{if(!N[t]){ee(t,r,a);return}const c=N[t][r]||[];a.length===c.length?ee(t,r,[]):ee(t,r,[...a])},ze=(t,r)=>{r&&(r.preventDefault(),r.stopPropagation()),i(Math.max(1,Math.min(t,Math.ceil(_.length/F))))},Re=async(t,r)=>{t&&(t.preventDefault(),t.stopPropagation());const a=he(N),c=a.length;if(c>100){y(`Cannot generate more than 100 images at once (currently: ${c} images)`);return}if(y(null),p(!0),I(0),console.log("Generated parameter combinations:",a),a.length===0){y("No valid parameter combinations found. Please check your parameter selections."),p(!1);return}let d=r||null;if(d===null){const k=et();k!==null&&(d=k)}if(d===null){y("Please select a SaveImage or PreviewImage node first."),p(!1);return}const M=[];try{for(const Z of a){const q=await Xe(Z);q.prompt_id?M.push(q.prompt_id):(console.error("Failed to get prompt_id from response:",q),M.push(""))}const k=Array(a.length).fill(null).map((Z,q)=>({url:`https://source.unsplash.com/random/300x300?sig=${Math.random()}`,params:it(N,q)}));b(k);const G=Date.now(),ne=5*60*1e3,oe=async()=>{if(Date.now()-G>ne){console.log("Timeout reached while waiting for images"),p(!1),v(!0),i(1);return}let Z=0;for(let q=0;q<M.length;q++){const ue=M[q];if(ue)try{const ie=await tt(ue,Number(d));ie&&(k[q]={...k[q],url:ie},Z++)}catch(ie){console.error(`Error fetching image for prompt ID ${ue}:`,ie)}}b([...k]),I(Z),Z===M.length||Date.now()-G>ne?(p(!1),v(!0),i(1)):setTimeout(oe,3e3)};oe()}catch(k){console.error("Error generating images:",k),p(!1)}},Fe=(t,r)=>{r&&(r.preventDefault(),r.stopPropagation()),L(t)},Ve=(t,r)=>{r.preventDefault(),r.stopPropagation(),W(t),U(!0)},Ge=t=>{t&&(t.preventDefault(),t.stopPropagation()),U(!1)},He=async t=>{if(t&&(t.preventDefault(),t.stopPropagation()),z!==null){console.log(`Applied image ${z+1} with parameters:`,_[z].params),ye.trackEvent({event_type:"parameter_debug_apply",message_type:"parameter_debug",message_id:Je(),data:{workflow:(await Q.graphToPrompt()).output,selected_params:_[z].params,all_params:N,count:Object.keys(N).length}});const r=_[z].params;r.nodeParams&&(Object.entries(r.nodeParams).forEach(([a,c])=>{const d=Q.graph._nodes_by_id[a];!d||!d.widgets||Object.entries(c).forEach(([M,k])=>{for(const G of d.widgets)if(G.name===M){G.value=k;break}})}),Q.graph.setDirtyCanvas(!1,!0),T(!0),setTimeout(()=>{T(!1)},3e3))}},re=(t,r)=>{if(t&&(t.preventDefault(),t.stopPropagation()),m===1&&r!==void 0){const a=[...o];a.splice(r,1),a.length===0?s&&(se({type:"SET_SCREEN_STATE",payload:null}),s()):se({type:"SET_SELECTED_NODE",payload:a});return}s?(se({type:"SET_SCREEN_STATE",payload:null}),s()):(h(0),v(!1),p(!1),y(null))};return!n||o.length===0?e.jsx("div",{className:"flex-1 flex flex-col items-center justify-center p-8 bg-gray-50 overflow-y-auto",onClick:t=>t.stopPropagation(),children:e.jsxs("div",{className:"max-w-lg p-8 bg-white rounded-lg shadow-sm border border-blue-100 relative",children:[e.jsxs("div",{className:"mb-6 text-center",children:[e.jsx("h3",{className:"text-base font-bold text-blue-800 mb-2",children:"GenLab"}),e.jsx("div",{className:"h-1 w-16 bg-blue-500 mx-auto rounded-full mb-4"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx("div",{className:"bg-blue-100 p-2 rounded-full text-blue-600",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{d:"M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"})})}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-gray-800",children:"Batch Test Parameter Pairs"}),e.jsx("p",{className:"text-xs text-gray-600",children:"Select a node to batch test parameter pairs"})]})]}),e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx("div",{className:"bg-indigo-100 p-2 rounded-full text-indigo-600",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z",clipRule:"evenodd"})})}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-gray-800",children:"How To Use"}),e.jsx("p",{className:"text-xs text-gray-600",children:"Click on any node in your workflow to start the parameter testing process"})]})]}),e.jsx("div",{className:"mt-6 text-center",children:e.jsx("p",{className:"text-xs text-gray-600 mb-3",children:"No node is currently selected"})})]})]})}):S?e.jsx("div",{className:"flex-1 overflow-y-auto bg-gray-50 p-4",onClick:t=>t.stopPropagation(),children:e.jsx(at,{generatedImages:_,selectedImageIndex:z,handleSelectImage:Fe,handleApplySelected:He,handlePrevious:me,handleClose:re,currentPage:Y,handlePageChange:ze,imagesPerPage:F,notificationVisible:u,modalVisible:H,modalImageUrl:E,openImageModal:Ve,closeImageModal:Ge})}):f?e.jsx("div",{className:"flex-1 overflow-y-auto bg-gray-50 p-4",onClick:t=>t.stopPropagation(),children:e.jsx(ot,{selectedNodes:o,paramTestValues:N,selectedParams:l,totalCount:R,completedCount:P,errorMessage:C,handleClose:re,setIsProcessing:p,setCurrentScreen:h})}):m===0?e.jsx("div",{className:"flex-1 overflow-y-auto bg-gray-50 p-4",onClick:t=>t.stopPropagation(),children:e.jsx(st,{selectedNodes:o,handleParamSelect:_e,selectedParams:l,handleNext:ve,handleClose:re})}):m===1?e.jsxs("div",{className:"flex-1 overflow-y-auto bg-gray-50 p-4",onClick:t=>t.stopPropagation(),children:[e.jsx(rt,{selectedNodes:o,paramTestValues:N,selectedParams:l,updateParamTestValues:ee,toggleDropdown:Ae,openDropdowns:w,handleTestValueSelect:Oe,searchTerms:V,handleSearch:Be,handleSelectAll:Te,handleNext:ve,handlePrevious:me,handleClose:re,inputValues:g,setInputValues:O,textInputs:D,handleTextInputChange:Pe,handleAddTextInput:Ie,handleRemoveTextInput:Ee,openAiWritingModal:We}),e.jsx(lt,{visible:te,aiWritingModalText:ce,setAiWritingModalText:pe,aiGeneratedTexts:ge,aiSelectedTexts:je,aiWritingLoading:ke,aiWritingError:Le,handleAiWriting:Me,toggleTextSelection:$e,addSelectedTexts:De,onClose:()=>X(!1)})]}):e.jsx("div",{className:"flex-1 overflow-y-auto bg-gray-50 p-4",onClick:t=>t.stopPropagation(),children:e.jsx(nt,{selectedNodes:o,paramTestValues:N,selectedParams:l,totalCount:R,errorMessage:C,handlePrevious:me,handleStartGeneration:Re,handleClose:re})})};export{gt as ParameterDebugInterface};
